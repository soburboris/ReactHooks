import React, { useEffect, useState,useContext } from 'react'


import useFetch from 'hooks/useFetch'
import { NavLink, Redirect} from 'react-router-dom'
import UserArticles from 'pages/userProfile/components/userArticles'
import { CurrentUserContext } from 'contexts/currentUser'

const UserProfile = ({location, match}) => {
    const [currentUserState] = useContext(CurrentUserContext)
    
    const slug = match.params.slug
    const isFavorites = location.pathname.includes('favorites')
    const apiURL = `/profiles/${slug}`
    const [{ response: fetchFollowResponse }, doFetchFollow] = useFetch(`${apiURL}`)
    const [, doFetchFollow1] = useFetch(`${apiURL}/follow`)
    const [{response}, doFetch] = useFetch(apiURL)
    const [follow, setFollow] =useState('')
    
    
  
    const isAuthor = () => {
        if (!response || !currentUserState.isLogged) {
            return false
        }

        return (
            response.profile.username === currentUserState.currentUser.username
        )
    }


    const handle = () => {
        if (follow === 'Follow') {
            setFollow('Unfollow')
            doFetchFollow1({
                method: 'post',
                data: {
                   
                    following: true
                }
                
            })
            
        }
        else {
            setFollow('Follow')
            doFetchFollow1({
                method: 'delete'
             
            })
            
        }
      
     
    }
    
    useEffect (() => {
        if (!fetchFollowResponse){
            return
        }
       if (fetchFollowResponse.profile.following) {

        setFollow('Unfollow')
    }
    else {
        setFollow('Follow')
    }
    
    console.log('follow',fetchFollowResponse &&fetchFollowResponse.profile.following)
   
    },[fetchFollowResponse])

    useEffect( async() => {
        await doFetch()
        await doFetchFollow()
      
      
    },[doFetch,slug,doFetchFollow])

    if (!response) {
        return null
    }
   
    return (
        <div className='profile-page'>
             <div className='user-info'>
                 <div className='container'>
                     <div className='row'>
                         <div className='col-xs-12 col-md-10 offset-md-1'>
                             <img className='user-img' alt='' src={response.profile.image} />
                             <h4>{response.profile.username}</h4>
                             <p></p>
                             {!isAuthor() && <button className='btn btn-sm action-btn btn-secondary' onClick={handle}>
                                 <i className='ion-plus-round'>&nbsp;{follow} &nbsp; {response.profile.username}</i>
                             </button>}
                         </div>
                     </div>
                 </div>
             </div>
             <div className='container'>
                 <div className='row'>
                    <div className='col-xs-12 col-md-10 offset-md-1'>
                        <div className='article-toggle'>
                            <ul className='nav nav-pills outline-active'>
                                <li className='nav-item'>
                                    <NavLink to={`/profiles/${response.profile.username}`} className='nav-link' exact>
                                        My Posts
                                    </NavLink>
                                </li>
                                <li className='nav-item'>
                                    <NavLink to={`/profiles/${response.profile.username}/favorites`} className='nav-link'>
                                        Favorites Posts
                                    </NavLink>
                                </li>
                            </ul>
                        </div>
                        <UserArticles
                            username={response.profile.username}
                            location={location}
                            isFavorites={isFavorites}
                            url={match.url}
                            
                        />
                    </div> 
                 </div>
             </div>
        </div>
    )
}

export default UserProfile